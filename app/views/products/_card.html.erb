<!-- Cached product card partial for performance -->
<%
  # Set default card_index if not provided
  card_index ||= 999
%>
<% cache ['product_card_v7', product, product.updated_at] do %>
  <div class="relative bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-all duration-300 cursor-pointer h-fit" data-product-id="<%= product.id %>">

    <!-- 이미지 갤러리 (16:9 비율) -->
    <div class="relative overflow-hidden group" style="aspect-ratio: 16/9;" data-gallery="<%= product.id %>">
      <%
        # 썸네일 이미지 우선순위 (모든 product_images 표시)
        gallery_images = []

        # 모든 product_images를 갤러리에 추가
        if product.product_images.attached?
          url_helper = Rails.application.routes.url_helpers
          only_path = Rails.env.production? ? false : true
          product.product_images.each do |img|
            gallery_images << { type: 'url', data: url_helper.rails_blob_path(img, only_path: only_path) }
          end
        end

        # 이미지가 없으면 placeholder
        gallery_images << { type: 'placeholder' } if gallery_images.empty?
      %>
      
      <!-- 이미지 슬라이드들 (극한 성능 최적화) -->
      <% gallery_images.each_with_index do |image, img_index| %>
        <div class="gallery-slide" style="<%= 'display: none;' unless img_index == 0 %>" data-slide="<%= img_index %>">
          <% if image[:type] == 'url' %>
            <img src="<%= image[:data] %>"
                 alt="<%= product.name %>"
                 width="320"
                 height="180"
                 loading="<%= img_index == 0 && card_index < 4 ? 'eager' : 'lazy' %>"
                 decoding="async"
                 fetchpriority="<%= img_index == 0 && card_index < 4 ? 'high' : 'low' %>"
                 crossorigin="anonymous"
                 class="w-full h-full object-cover object-center transition-transform duration-300 hover:scale-105">
          <% else %>
            <div class="w-full h-full flex items-center justify-center" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);">
              <span style="color: white; font-weight: bold; font-size: 2rem;"><%= product.name[0].upcase %></span>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent"></div>
      
      <!-- 이미지 네비게이션 -->
      <% if gallery_images.length > 1 %>
        <button class="absolute left-2 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10" onclick="ProductGallery.prev(event, <%= product.id %>)">
          <i class="ri-arrow-left-s-line text-sm"></i>
        </button>
        <button class="absolute right-2 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10" onclick="ProductGallery.next(event, <%= product.id %>)">
          <i class="ri-arrow-right-s-line text-sm"></i>
        </button>
        
        <!-- 도트 인디케이터 -->
        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-1">
          <% gallery_images.each_with_index do |_, dot_index| %>
            <div class="gallery-dot w-1.5 h-1.5 rounded-full transition-all duration-200 <%= dot_index == 0 ? 'bg-white' : 'bg-white/50' %>" onclick="ProductGallery.goTo(event, <%= product.id %>, <%= dot_index %>)" data-dot="<%= dot_index %>"></div>
          <% end %>
        </div>
      <% else %>
        <!-- 단일 이미지 -->
        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-1">
          <div class="w-1.5 h-1.5 rounded-full transition-all duration-200 bg-white"></div>
        </div>
      <% end %>
    </div>
    
    <!-- 제품 정보 -->
    <div class="relative p-4 bg-white product-card-content"
         onclick="window.location.href='<%= product_path(product) %>'"
         data-product-id="<%= product.id %>"
         data-product-card="<%= product.id %>">
      <div class="flex items-center mb-2">
        <!-- 제품 로고 (작은 아이콘) -->
        <div class="mr-2" style="width: 24px; height: 24px; flex-shrink: 0; border-radius: 6px; overflow: hidden;">
          <% if product.logo_image.attached? %>
            <img src="<%= product.logo_thumb_1x %>" alt="<%= product.name %> 로고" style="width: 100%; height: 100%; object-fit: cover;">
          <% else %>
            <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.75rem;">
              <%= product.name[0].upcase %>
            </div>
          <% end %>
        </div>
        <h3 class="font-semibold text-gray-900 text-base truncate"><%= product.name %></h3>
      </div>
      
      <p class="text-sm text-gray-600 mb-3 line-clamp-2"><%= truncate(product.description || product.tagline, length: 100) %></p>
      
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none" style="width: 16px; height: 16px; margin-right: 0.25rem;">
              <path d="M8 3.5C8 3.5 8.5 3 9 3.8L11.5 8.5C12 9.3 11.8 10 11 10H5C4.2 10 4 9.3 4.5 8.5L7 3.8C7.5 3 8 3.5 8 3.5Z" stroke="#6B7280" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
            <!-- Use counter cache for performance -->
            <span class="text-sm text-gray-500"><%= product.votes_count || 0 %></span>
          </div>
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 16 16" style="width: 16px; height: 16px; margin-right: 0.25rem;">
              <path stroke="#6B7280" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" fill="none" d="M14 7.667a5.667 5.667 0 0 1-7.703 5.287 2.286 2.286 0 0 0-.22-.078.571.571 0 0 0-.126-.016c-.06 0-.12.006-.2.014l-3.413.353c-.326.034-.488.05-.584-.008a.343.343 0 0 1-.157-.233c-.017-.111.06-.255.217-.543l1.09-2.018c.09-.167.135-.25.155-.329a.571.571 0 0 0 .018-.217c-.007-.083-.042-.19-.114-.403A5.667 5.667 0 1 1 14 7.667Z"></path>
            </svg>
            <span class="text-sm text-gray-500"><%= product.comments_count || 0 %></span>
          </div>
        </div>
        <div class="w-4 h-4 flex items-center justify-center">
          <i class="ri-arrow-right-line text-gray-400 text-sm"></i>
        </div>
      </div>
    </div>
    
    <!-- 간단한 모달 -->
    <div class="product-modal" id="modal-<%= product.id %>">
      <h4 class="modal-title"><%= product.name %></h4>
      
      <p class="modal-description">
        <%= truncate(product.description.present? ? product.description : product.tagline, length: 120) %>
      </p>
      
      <div class="modal-features">
        <h5>주요 기능</h5>
        <ul>
          <% 
            features = product.key_features_list.present? ? 
              product.key_features_list.first(3) : 
              ["사용자 친화적 인터페이스", "실시간 데이터 처리", "다중 플랫폼 지원"]
          %>
          <% features.each do |feature| %>
            <li><%= feature %></li>
          <% end %>
        </ul>
      </div>
      
      <%= link_to product_path(product), class: "modal-button" do %>
        자세히 보기
      <% end %>
    </div>
  </div>
<% end %>